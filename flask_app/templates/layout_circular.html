<!DOCTYPE html>
<meta charset="utf-8">
<style>
.nav a {
    text-decoration:None;
}
.nav a:hover {
    color: blue;
}
.link {
  fill: none;
  stroke:#001;
}
.link.intra {
  stroke-width: 1.6px;
  stroke-opacity: .35;
   
}
.link.query {
  stroke-width: 1.4px;
  stroke-opacity: .1;  
}
.link.inter{
  stroke:#110;
  stroke-width: 2.2px;
  stroke-opacity: .65;  
}
.link.over{
    stroke:#F01;
    stroke-width: 2.8px;
    stroke-opacity: .9;  
}
.link.noOver {
  stroke-opacity: .15;  
}

.label  {
    fill: #000;
    font-family: sans-serif;
    cursor:pointer;
}
.label.over {
    fill: #F00;
}
.label.over.mouse {
    font-weight: 900;
}

.node {
  stroke: None;
}
.node.query {
  stroke: #100;
  stroke-width: 1.6px;
  fill: #FFF;
}
.label.over .query {
  stroke: #F00;
}
.label.overLink .query {
 stroke: #34E;
}
.label.overLink {
    fill: #34E;
}
.link.overLink {
    stroke: #34E;
    stroke-width:2.2px;
    stroke-opacity: .65;  
}



</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.hive.v0.min.js"></script>
<script>


var width = window.innerWidth,
    height = 600,
    radius = 380;

var xCenter = width/2,
    yCenter = height-30; 

var puceRadius = 3;

var deltaTheta;

var degName = 'gdeg'; // 'deg_loc';  // Choose deg Local or degre Graph 

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
        .append("g");

draw( 'tourner' );

function draw( query ){
// see
// http://stackoverflow.com/questions/18831949/d3js-make-new-parent-data-descend-into-child-nodes
// http://stackoverflow.com/questions/17086415/d3-how-to-properly-chain-transitions-on-different-selections

    /* ---- start JSON ---- */
    d3.json("/data/"+query, function(error, myData) {

        var nodes = myData['nodes'],
            links = myData['links'],
            nNodes = myData['nNodes'],
            query = myData['query'];
           
        deltaTheta = Math.PI/(nNodes-1);  // en radian  (Global... )

    var dtime = 1000;
    
   /* -- Labels -- */
        // data
        var objsLab =  svg.selectAll("text")
            .data(nodes, function(d){return d['gid'];} )
    
      /*   // font size
         var degMax = d3.max( nodes, function(d) { return d[ degName ];} );
         var fontSizeScale = d3.scale.pow().exponent(.5)
                                 .domain([1, degMax])  // .domain([minDataPoint,maxDataPoint])
                                 .range([13, 24]);  */
    
        // Exit
        var exitTransition = d3.transition().duration(dtime).each(function() {
              objsLab.exit()
                  .style("fill", "red")
               .transition()
                  .style("opacity", 1e-6)
                  .remove();
        });

        // Update
        var updateTransition = exitTransition.transition().each(function() {

               objsLab
                /*.attr("style", function(d){   
                        var s = '';    
                        if( Math.cos( deltaTheta*d['iDelta']  )>0 ){  s += "text-anchor:end; "; }
                        else {   s+= "text-anchor:start; ";  }        
                            
                        //s+= "font-size: "+ fontSizeScale(d[ degName ]) +"px ;";
                        s+= "dominant-baseline: middle;"
                        return s;
                    } ) */
                     .style("opacity", 1)
                     .style('fill', '#71bc78' )
                .transition()
                   .attr("transform", function(d){return translateLabel(d);})
                    ;
             
                // .transition().duration(duration);

        });

        // Enter
        var enterTransition = updateTransition.transition().each(function() {

              gEnter = objsLab.enter().append("text")
                      .attr("class", "label")
                      .attr("id", function(d) { return "node-" + d['gid']; })
                            //  .on("mouseover", mouseOverLabel)
                            //  .on("mouseout", mouseOutLabel)
                      .on( "click", onClick )
                      .text( function(d){ return d['label'] ; })
                      .attr("y", 1 ) 
                      .attr("x", 0)
                      /*  .attr("style", function(d){   
                                var s = '';    
                                if( Math.cos( deltaTheta*d['iDelta']  )>0 ){  s += "text-anchor:end; "; }
                                else {   s+= "text-anchor:start; ";  }        
                                    
                                //s+= "font-size: "+ fontSizeScale(d[ degName ]) +"px ;";
                                s+= "dominant-baseline: middle;"
                                //s+= "opacity:0";
                                //s += "fill:#71bc78"
                                return s;
                            } ) */
                       .style("opacity", 1e-6)
                        .attr("transform", function(d){return translateLabel(d);})
                        .transition() // .delay( 300 )
                           .style('opacity', 1);
     
        });
                


     

    });  // <-- fin lecture Json
} // <-- fin de Draw



        function xPosition( rayon , i ){
            return xCenter - rayon*Math.cos( deltaTheta*i  );
        }
        function yPosition( rayon , i ){
            return yCenter - rayon*Math.sin(  deltaTheta*i  );
        }

    /* -- mouse Over -- */
    function mouseOverLabel(d){
        //console.log(  d['label'] )
        svg.select("#node-" + d['gid']).classed('over mouse', true );// le noeud sous la souris

        svg.selectAll("path.link")
            .classed("noOver", true);

        svg.selectAll("path.link.target-" + d['id'])
            .classed("over", true)
            .classed("noOver", false)
            .each( function(d){ 
                    this.parentNode.appendChild(this);   // go on top layer
                    svg.select("#node-" + d['s']).classed('over', true );
                  } );

          svg.selectAll("path.link.source-"  + d['id'])
              .classed("over", true) 
            .classed("noOver", false) 
              .each( function(d){ 
                        this.parentNode.appendChild(this);   // go on top layer
                        svg.select("#node-" + d['t']).classed('over', true );
                     } );
    }

    function mouseOutLabel(d){
         svg.select("#node-" + d['gid']).classed('over mouse', false ); // le noeud sous la souris
      
        svg.selectAll("path.link")
            .classed("noOver", false);

        svg.selectAll("path.link.target-" + d['id'])
              .classed("over", false)
            .classed("noOver", false) 
                .each( function(d){ 
                    svg.select("#node-" + d['s']).classed('over', false );
                                 } );

          svg.selectAll("path.link.source-" + d['id'])
              .classed("over", false)
              .classed("noOver", false)      
              .each( function(d){ 
                    svg.select("#node-" + d['t']).classed('over', false );
                    } );
    }


   // ------
    function translateLabel( d ){

        var outerRad = radius + 10;

        var dx = xPosition( outerRad ,  d['iDelta']  );
        var dy = yPosition( outerRad ,  d['iDelta']  );

        if( Math.cos( deltaTheta*d['iDelta']  )>0 ) { var sens = 0; }
        else { var sens = -180;  }

        var angle = .75*(sens+deltaTheta*d['iDelta']*180/Math.PI) //<- coefficient 'brosse'

        return "translate("+dx+", "+dy+") rotate("+ angle +") "
    }

   /* -- Liens -- */
/*
    linksElts = svg.selectAll(".link")
             .data(links, function(d){return d['id'];});

        linksElts.exit().transition()
           // .duration(1000)
          //  .attr('style', 'opacity:0')
            .remove();
       
        linksElts.transition();
            //.duration(1000);
            //.attr("d", function(d){ return linkArc(d) ;} ); 

      linksElts.enter().append("path")
        .attr("class", function(d){ var c = 'link ';
                if( d["type"]==="query" ){ c += "query"; }
                else if (d["type"]==="inter")  { c += "inter"; }
                else    { c += "intra"; }
                c += ' source-'+d['s'] + ' target-'+d['t'];  // pour le rollover sur les labels

                var c_ids = [clusters_id[d['s']], clusters_id[d['t']] ].sort();
                c += ' c-'+ c_ids[0] + c_ids[1] ;  // pour le rollover sur les liens
                return c;   }  )
        .attr("d", function(d){ return linkArc(d) ;} ); 

*/
    /* -- Roll over pour les liens  -- */
/*        svg.selectAll("path.link").on("mouseover", mouseOverLink)
                                      .on("mouseout", mouseOutLink); 
    function mouseOverLink(d){
          svg.select("#node-" + d['s']).classed('overLink', true );
          svg.select("#node-" + d['t']).classed('overLink', true );

            var c_ids = [clusters_id[d['s']], clusters_id[d['t']] ].sort();
            var c_class = 'c-'+ c_ids[0] + c_ids[1] ; 

        svg.selectAll("path.link")
            .classed("noOver", true);

        svg.selectAll("path.link." + c_class )
            .classed("noOver", false)
            .classed("overLink", true)
            .each( function(d){ 
                    this.parentNode.appendChild(this);   // go on top layer
                    svg.select("#node-" + d['s']).classed('overLink', true );
                    svg.select("#node-" + d['t']).classed('overLink', true );
                  } );


    }
    function mouseOutLink(d){

            var c_ids = [clusters_id[d['s']], clusters_id[d['t']] ].sort();
            var c_class = 'c-'+ c_ids[0] + c_ids[1] ; 

            svg.select("#node-" + d['s']).classed('overLink', false );
            svg.select("#node-" + d['t']).classed('overLink', false );

            svg.selectAll("path.link")
                .classed("noOver", false);

            svg.selectAll("path.link." + c_class )
              .classed("overLink", false)
               .each( function(d){ 
                        svg.select("#node-" + d['s']).classed('overLink', false );
                        svg.select("#node-" + d['t']).classed('overLink', false );
                      } );
    }

    function linkArc( d ){
        // liens en arc de cercle 
        var R = radius - puceRadius;

        var startX = xPosition( R , iDelta[ d['s'] ]   );
            startY = yPosition( R , iDelta[ d['s'] ]   );

        var endX = xPosition( R , iDelta[ d['t'] ]   );
            endY = yPosition( R , iDelta[ d['t'] ]   );

        // ** !!! rayon infini  ***
        var phi = Math.abs( deltaTheta*( iDelta[d['s']] - iDelta[d['t']] ));

        if( phi > Math.PI*0.99 ) { 
            path = "m "+startX+","+startY+" L "+endX+","+endY ;
            return path
        }   

        var r = Math.tan( phi/2 )*R;
        
        // gestion de l'orientation de l'arc (flag) :
        if ( (iDelta[d['s']] - iDelta[d['t']] ) < 0 ){ var flag = 0;   }
        else { var flag = 1; }

        var path = "m "+startX+","+startY+" A"+r+","+r+" 0 0,"+flag+" "+endX+","+endY ;

        return path;
    }
*/



function onClick( d ){
    newQuery = d['label'];
    draw( newQuery );
}

</script>

<p class="nav">[ <a href="/tournesol/{{query}}/">tournesol</a>, <a href="/square/{{query}}/">square</a> ]
</p>

</body>
